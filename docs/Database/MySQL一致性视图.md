# MySQL一致性视图的底层原理


1. Innodb中每个事务都有一个唯一Id，并且严格按顺序递增。这个Id只有在事务开始时才能申请到。
2. 事务开始不是执行begin，而是从执行第一条SQL语句开始。执行start transaction with consistent snapshot可以开启事务并拿到一致性视图，如果不执行这条语句，那在执行一致性读语句时才能拿到一致性视图(如：select x from test where id = 1)。
3. 在可重复读的隔离级别下，一致性视图只获取一次，在读已提交的隔离级别下，每次执行SQL都会获取一致性视图。

以T5时刻为例：
拿一致性视图会做3件事：

1. 把当前还没提交的事务Id保存到一个数组里
2. 找到已提交事务的最大值
3. 找到当前系统里已存在事务的最大值

在可重复读隔离级别下，获取x的值的过程：
事务A在T5时刻获取一致性视图

1. 把3，5，6，7，8保存到一个数组里
2. 找到已提交事务最大值4
3. 找到系统事务的最大值8

然后获取x值的版本号，最新的版本是trx_id=5，发现5在未提交事务的数组里，所以这个数据应该是不可见的，通过undolog找到上一个版本trx_id=7，发现7也在未提交的数组里，继续找上一个版本trx_id=4，发现4不在未提交事务的数组里，并且小于等于已提交事务的最大值，那么就读到x=0
可重复读在T7时刻获取的一致性视图不变

读已提交在T5时刻同上，但在T7时刻获取一致性视图：

1. 把3，5，6，8保存到一个数组里
2. 找到已提交事务最大值7
3. 找到系统事务的最大值8

然后获取x值的版本号，最新的版本是trx_id=5，发现5在未提交事务的数组里，所以这个数据应该是不可见的，通过undolog找到上一个版本trx_id=7，发现7不在未提交事务的数组里，并且小于等于已提交事务的最大值，那么就读到x=1

[MYSQL](drawio/一致性事务.drawio ':include :type=code')
